From bcf86b2acbc088d24af5df7b627ebb1f377d9e0e Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Juho=20H=C3=A4m=C3=A4l=C3=A4inen?=
 <juho.hamalainen@jolla.com>
Date: Tue, 29 Mar 2016 13:13:59 +0300
Subject: [PATCH 2002/2003] combine-sink: Add argument for ignoring sinks in
 automatic mode.

---
 src/modules/module-combine-sink.c | 36 +++++++++++++++++++++++++++++++++++-
 1 file changed, 35 insertions(+), 1 deletion(-)

diff --git a/src/modules/module-combine-sink.c b/src/modules/module-combine-sink.c
index b6322c6..9182c67 100644
--- a/src/modules/module-combine-sink.c
+++ b/src/modules/module-combine-sink.c
@@ -44,6 +44,8 @@
 #include <pulsecore/rtpoll.h>
 #include <pulsecore/time-smoother.h>
 #include <pulsecore/strlist.h>
+#include <pulsecore/hashmap.h>
+#include <pulsecore/idxset.h>
 
 #include "module-combine-sink-symdef.h"
 
@@ -55,6 +57,7 @@ PA_MODULE_USAGE(
         "sink_name=<name for the sink> "
         "sink_properties=<properties for the sink> "
         "slaves=<slave sinks> "
+        "ignore=<slave sinks to ignore in automatic mode> "
         "adjust_time=<how often to readjust rates in s> "
         "resample_method=<method> "
         "format=<sample format> "
@@ -74,6 +77,7 @@ static const char* const valid_modargs[] = {
     "sink_name",
     "sink_properties",
     "slaves",
+    "ignore",
     "adjust_time",
     "resample_method",
     "format",
@@ -141,6 +145,8 @@ struct userdata {
     bool automatic;
     bool auto_desc;
 
+    pa_hashmap *ignore_sinks;
+
     pa_strlist *unlinked_slaves;
 
     pa_hook_slot *sink_put_slot, *sink_unlink_slot, *sink_state_changed_slot;
@@ -1153,6 +1159,9 @@ static bool is_suitable_sink(struct userdata *u, pa_sink *s) {
         if (!pa_streq(t, "sound"))
             return false;
 
+    if (u->ignore_sinks && pa_hashmap_get(u->ignore_sinks, s->name))
+        return false;
+
     return true;
 }
 
@@ -1252,7 +1261,7 @@ static pa_hook_result_t sink_state_changed_hook_cb(pa_core *c, pa_sink *s, struc
 int pa__init(pa_module*m) {
     struct userdata *u;
     pa_modargs *ma = NULL;
-    const char *slaves, *rm;
+    const char *slaves, *rm, *ignore;
     int resample_method = PA_RESAMPLER_TRIVIAL;
     pa_sample_spec ss;
     pa_channel_map map;
@@ -1306,6 +1315,28 @@ int pa__init(pa_module*m) {
     slaves = pa_modargs_get_value(ma, "slaves", NULL);
     u->automatic = !slaves;
 
+    if ((ignore = pa_modargs_get_value(ma, "ignore", NULL))) {
+        const char* split_state = NULL;
+        char *n = NULL;
+
+        if (!u->automatic) {
+            pa_log("ignore is not valid argument when not in automatic mode");
+            goto fail;
+        }
+
+        u->ignore_sinks = pa_hashmap_new_full(pa_idxset_string_hash_func,
+                                              pa_idxset_string_compare_func,
+                                              pa_xfree,
+                                              NULL);
+
+        while ((n = pa_split(ignore, ",", &split_state))) {
+            if (!pa_hashmap_get(u->ignore_sinks, n))
+                pa_hashmap_put(u->ignore_sinks, n, PA_UINT_TO_PTR(1));
+            else
+                pa_xfree(n);
+        }
+    }
+
     ss = m->core->default_sample_spec;
     map = m->core->default_channel_map;
 
@@ -1503,6 +1534,9 @@ void pa__done(pa_module*m) {
 
     pa_strlist_free(u->unlinked_slaves);
 
+    if (u->ignore_sinks)
+        pa_hashmap_free(u->ignore_sinks);
+
     if (u->sink_put_slot)
         pa_hook_slot_free(u->sink_put_slot);
 
-- 
2.1.4

