From 48e3e1dd29fc31a38d68b9c97de7ff0220917395 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Juho=20H=C3=A4m=C3=A4l=C3=A4inen?=
 <juho.hamalainen@jolla.com>
Date: Mon, 4 Apr 2016 17:41:18 +0300
Subject: [PATCH 2003/2003] loopback: Prevent crash when unloading module after
 sink_input move.

---
 src/modules/module-loopback.c | 7 +++++++
 1 file changed, 7 insertions(+)

diff --git a/src/modules/module-loopback.c b/src/modules/module-loopback.c
index 37bf7b1..0788ca2 100644
--- a/src/modules/module-loopback.c
+++ b/src/modules/module-loopback.c
@@ -136,6 +136,13 @@ static void teardown(struct userdata *u) {
     pa_assert(u);
     pa_assert_ctl_context();
 
+    /* Set message handler to default handler. In case there was sink_input
+     * move just before the module was unloaded there would be one update to
+     * max request right before unloading the module. This would result in a
+     * call to adjust_rates somewhere after the struct userdata has been
+     * freed causing a segfault. */
+    u->sink_input->parent.process_msg = pa_sink_input_process_msg;
+
     u->adjust_time = 0;
     enable_adjust_timer(u, false);
 
-- 
2.1.4

